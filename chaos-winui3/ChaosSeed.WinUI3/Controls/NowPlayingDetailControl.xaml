<UserControl
    x:Class="ChaosSeed.WinUI3.Controls.NowPlayingDetailControl"
    x:Name="Root"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:local="using:ChaosSeed.WinUI3.Controls"
    xmlns:conv="using:ChaosSeed.WinUI3.Converters">

    <UserControl.Resources>
        <SolidColorBrush x:Key="LyricActiveBrush" Color="{ThemeResource SystemAccentColor}" />
        <conv:BoolToBrushConverter
            x:Key="LyricForegroundConverter"
            TrueBrush="{StaticResource LyricActiveBrush}"
            FalseBrush="{ThemeResource TextFillColorPrimaryBrush}" />

        <Style x:Key="LyricsListItemStyle" TargetType="ListViewItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="Transparent" />
        </Style>
    </UserControl.Resources>

    <Border
        x:Name="RootCard"
        Margin="24"
        CornerRadius="20"
        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
        Padding="{x:Bind CardPadding, Mode=OneWay}"
        HorizontalAlignment="Center"
        VerticalAlignment="Center"
        Width="{x:Bind CardWidth, Mode=OneWay}"
        Height="{x:Bind CardHeight, Mode=OneWay}">

        <Grid RowSpacing="{x:Bind LayoutRowSpacing, Mode=OneWay}" ColumnSpacing="{x:Bind LayoutColumnSpacing, Mode=OneWay}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Top -->
            <Grid Grid.Row="0" ColumnSpacing="12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Button Click="OnCloseClicked" ToolTipService.ToolTip="关闭">
                    <muxc:SymbolIcon Symbol="Back" />
                </Button>
                <StackPanel Grid.Column="1" Spacing="2" VerticalAlignment="Center">
                    <TextBlock x:Name="HeaderTitleText" Text="正在播放" FontWeight="SemiBold" FontSize="{x:Bind HeaderFontSize, Mode=OneWay}" />
                    <TextBlock x:Name="HeaderSubText" Text="" Opacity="0.7" TextTrimming="CharacterEllipsis" FontSize="{x:Bind HeaderSubFontSize, Mode=OneWay}" />
                </StackPanel>
            </Grid>

            <!-- Content -->
            <Grid Grid.Row="1" x:Name="ContentGrid" ColumnSpacing="{x:Bind ContentColumnSpacing, Mode=OneWay}" RowSpacing="{x:Bind ContentRowSpacing, Mode=OneWay}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Border
                    x:Name="CoverCard"
                    Grid.Row="0"
                    Grid.RowSpan="3"
                    Grid.Column="0"
                    CornerRadius="{x:Bind CoverCornerRadius, Mode=OneWay}"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    Width="{x:Bind CoverSize, Mode=OneWay}"
                    Height="{x:Bind CoverSize, Mode=OneWay}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                    <Image x:Name="CoverImg" Stretch="UniformToFill" />
                </Border>

                <StackPanel
                    x:Name="TitlePanel"
                    Grid.Row="0"
                    Grid.Column="1"
                    Spacing="{x:Bind TitleSpacing, Mode=OneWay}"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    MaxWidth="{x:Bind TitleMaxWidth, Mode=OneWay}">
                    <TextBlock x:Name="TitleText" Text="-" FontSize="{x:Bind TitleFontSize, Mode=OneWay}" FontWeight="SemiBold" TextWrapping="Wrap" TextAlignment="Center" />
                    <TextBlock x:Name="ArtistText" Text="" FontSize="{x:Bind MetaFontSize, Mode=OneWay}" Opacity="0.78" TextWrapping="Wrap" TextAlignment="Center" />
                    <TextBlock x:Name="AlbumText" Text="" FontSize="{x:Bind MetaFontSize, Mode=OneWay}" Opacity="0.6" TextWrapping="Wrap" TextAlignment="Center" />
                    <TextBlock x:Name="LyricsStatusText" Text="" FontSize="{x:Bind MetaFontSize, Mode=OneWay}" Opacity="0.55" TextWrapping="NoWrap" TextAlignment="Center" />
                </StackPanel>

                <ListView
                    x:Name="LyricsList"
                    Grid.Row="1"
                    Grid.RowSpan="2"
                    Grid.Column="1"
                    ItemsSource="{x:Bind LyricsLines, Mode=OneWay}"
                    SelectionMode="None"
                    IsItemClickEnabled="False"
                    ItemContainerStyle="{StaticResource LyricsListItemStyle}"
                    Padding="{x:Bind LyricsPadding, Mode=OneWay}"
                    Background="Transparent"
                    BorderThickness="0"
                    ScrollViewer.VerticalScrollBarVisibility="Hidden"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="local:NowPlayingLyricsLineVm">
                            <StackPanel Spacing="{Binding ElementName=Root, Path=LyricsLineSpacing}" Padding="4">
                                <TextBlock
                                    Text="{x:Bind Original}"
                                    Opacity="{x:Bind Opacity}"
                                    FontWeight="{x:Bind FontWeight}"
                                    FontSize="{Binding ElementName=Root, Path=LyricFontSize}"
                                    Foreground="{Binding IsActive, Converter={StaticResource LyricForegroundConverter}}"
                                    TextWrapping="Wrap"
                                    TextAlignment="Center" />
                                <TextBlock
                                    Text="{x:Bind TranslationText}"
                                    Visibility="{x:Bind TranslationVisibility}"
                                    Opacity="{x:Bind TranslationOpacity}"
                                    FontSize="{Binding ElementName=Root, Path=LyricTranslationFontSize}"
                                    Foreground="{Binding IsActive, Converter={StaticResource LyricForegroundConverter}}"
                                    TextWrapping="Wrap"
                                    TextAlignment="Center" />
                            </StackPanel>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <VisualStateManager.VisualStateGroups>
                    <VisualStateGroup>
                        <VisualState x:Name="Narrow">
                            <VisualState.StateTriggers>
                                <AdaptiveTrigger MinWindowWidth="0" />
                            </VisualState.StateTriggers>
                            <VisualState.Setters>
                                <Setter Target="CoverCard.(Grid.Row)" Value="0" />
                                <Setter Target="CoverCard.(Grid.Column)" Value="0" />
                                <Setter Target="CoverCard.(Grid.RowSpan)" Value="1" />
                                <Setter Target="CoverCard.(Grid.ColumnSpan)" Value="2" />
                                <Setter Target="TitlePanel.(Grid.Row)" Value="1" />
                                <Setter Target="TitlePanel.(Grid.Column)" Value="0" />
                                <Setter Target="TitlePanel.(Grid.ColumnSpan)" Value="2" />
                                <Setter Target="LyricsList.(Grid.Row)" Value="2" />
                                <Setter Target="LyricsList.(Grid.Column)" Value="0" />
                                <Setter Target="LyricsList.(Grid.RowSpan)" Value="1" />
                                <Setter Target="LyricsList.(Grid.ColumnSpan)" Value="2" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState x:Name="Wide">
                            <VisualState.StateTriggers>
                                <AdaptiveTrigger MinWindowWidth="960" />
                            </VisualState.StateTriggers>
                            <VisualState.Setters>
                                <Setter Target="CoverCard.(Grid.Row)" Value="0" />
                                <Setter Target="CoverCard.(Grid.Column)" Value="0" />
                                <Setter Target="CoverCard.(Grid.RowSpan)" Value="3" />
                                <Setter Target="CoverCard.(Grid.ColumnSpan)" Value="1" />
                                <Setter Target="TitlePanel.(Grid.Row)" Value="0" />
                                <Setter Target="TitlePanel.(Grid.Column)" Value="1" />
                                <Setter Target="TitlePanel.(Grid.ColumnSpan)" Value="1" />
                                <Setter Target="LyricsList.(Grid.Row)" Value="1" />
                                <Setter Target="LyricsList.(Grid.Column)" Value="1" />
                                <Setter Target="LyricsList.(Grid.RowSpan)" Value="2" />
                                <Setter Target="LyricsList.(Grid.ColumnSpan)" Value="1" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateManager.VisualStateGroups>
            </Grid>

            <!-- Bottom transport -->
            <Grid Grid.Row="2" RowSpacing="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                    <Button Click="OnLoopClicked" ToolTipService.ToolTip="循环模式">
                        <TextBlock x:Name="LoopText" Text="1" FontWeight="SemiBold" />
                    </Button>
                    <Button Click="OnPrevClicked" ToolTipService.ToolTip="上一首">
                        <muxc:SymbolIcon Symbol="Back" />
                    </Button>
                    <Button Click="OnPlayPauseClicked" ToolTipService.ToolTip="播放/暂停" CornerRadius="999" MinWidth="46" MinHeight="46">
                        <Button.Background>
                            <SolidColorBrush Color="{ThemeResource SystemAccentColor}" Opacity="0.95" />
                        </Button.Background>
                        <muxc:SymbolIcon x:Name="PlayPauseIcon" Symbol="Play" Foreground="White" />
                    </Button>
                    <Button Click="OnNextClicked" ToolTipService.ToolTip="下一首">
                        <muxc:SymbolIcon Symbol="Forward" />
                    </Button>
                </StackPanel>

                <Grid Grid.Row="1" ColumnSpacing="10" VerticalAlignment="Center">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock x:Name="PosText" Text="00:00" Opacity="0.75" VerticalAlignment="Center" />
                    <Slider
                        x:Name="PosSlider"
                        Grid.Column="1"
                        Minimum="0"
                        Maximum="1"
                        StepFrequency="1"
                        SmallChange="1"
                        LargeChange="5"
                        ValueChanged="OnPositionChanged" />
                    <TextBlock x:Name="DurText" Grid.Column="2" Text="--:--" Opacity="0.75" VerticalAlignment="Center" />
                </Grid>
            </Grid>
        </Grid>
    </Border>
</UserControl>
