<Page
    x:Class="ChaosSeed.WinUI3.Pages.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls">

    <ScrollViewer>
        <Grid Padding="{StaticResource ChaosPagePadding}">
            <Grid.Transitions>
                <TransitionCollection>
                    <EntranceThemeTransition FromVerticalOffset="10" />
                </TransitionCollection>
            </Grid.Transitions>
            <StackPanel Spacing="12">
                <TextBlock Text="设置" FontSize="28" FontWeight="SemiBold" />
                <TextBlock Text="提示：主题 / Backdrop / 直播后端 会自动持久化。" Opacity="0.8" />

                <Border Style="{StaticResource ChaosCardBorderStyle}" Padding="16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="更新" FontSize="18" FontWeight="SemiBold" />

                        <TextBlock x:Name="UpdateCurrentVersionText" Text="当前版本：" Opacity="0.85" />

                        <muxc:InfoBar
                            x:Name="UpdatePackagedHint"
                            IsOpen="False"
                            Severity="Informational"
                            Title="提示"
                            Message="你正在使用 MSIX 安装版：更新由系统（AppInstaller）托管，此处无需自更新。" />

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="自动检测更新" VerticalAlignment="Center" />
                            <ToggleSwitch
                                x:Name="AutoUpdateToggle"
                                Grid.Column="1"
                                OffContent="关闭"
                                OnContent="开启"
                                Toggled="OnAutoUpdateToggled" />
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="检测间隔（小时）" VerticalAlignment="Center" />
                            <muxc:NumberBox
                                x:Name="AutoUpdateIntervalBox"
                                Grid.Column="1"
                                Minimum="1"
                                Maximum="336"
                                SmallChange="1"
                                SpinButtonPlacementMode="Compact"
                                ValueChanged="OnAutoUpdateIntervalChanged" />
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="检查更新" VerticalAlignment="Center" />
                            <Button
                                x:Name="CheckUpdateButton"
                                Grid.Column="1"
                                Content="检查"
                                Click="OnCheckUpdateClicked" />
                        </Grid>

                        <ProgressBar
                            x:Name="UpdateProgressBar"
                            Minimum="0"
                            Maximum="100"
                            Value="0"
                            Visibility="Collapsed" />

                        <TextBlock x:Name="UpdateStatusText" Text="" Opacity="0.85" TextWrapping="Wrap" />

                        <muxc:InfoBar
                            x:Name="UpdateInfoBar"
                            IsOpen="False"
                            Severity="Informational"
                            Title="更新"
                            Message="">
                            <muxc:InfoBar.ActionButton>
                                <Button x:Name="UpdateNowButton" Content="立即更新" Click="OnUpdateNowClicked" />
                            </muxc:InfoBar.ActionButton>
                        </muxc:InfoBar>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource ChaosCardBorderStyle}" Padding="16">
                    <StackPanel Spacing="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="主题" VerticalAlignment="Center" />
                            <ComboBox x:Name="ThemeCombo" Grid.Column="1" SelectionChanged="OnThemeChanged">
                                <ComboBoxItem Content="跟随系统" Tag="FollowSystem" />
                                <ComboBoxItem Content="深色模式" Tag="Dark" />
                                <ComboBoxItem Content="浅色模式" Tag="Light" />
                            </ComboBox>
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Backdrop（Win11）" VerticalAlignment="Center" />
                            <ComboBox x:Name="BackdropCombo" Grid.Column="1" SelectionChanged="OnBackdropChanged">
                                <ComboBoxItem Content="Mica（更像原生）" Tag="Mica" />
                                <ComboBoxItem Content="Mica Alt（更浅/更分层）" Tag="MicaAlt" />
                                <ComboBoxItem Content="无" Tag="None" />
                            </ComboBox>
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="直播后端" VerticalAlignment="Center" />
                            <ComboBox x:Name="LiveBackendCombo" Grid.Column="1" SelectionChanged="OnLiveBackendChanged">
                                <ComboBoxItem Content="自动（优先 FFI）" Tag="Auto" />
                                <ComboBoxItem Content="FFI（chaos_ffi.dll）" Tag="Ffi" />
                                <ComboBoxItem Content="Daemon（chaos-daemon.exe）" Tag="Daemon" />
                            </ComboBox>
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="歌词后端" VerticalAlignment="Center" />
                            <ComboBox x:Name="LyricsBackendCombo" Grid.Column="1" SelectionChanged="OnLyricsBackendChanged">
                                <ComboBoxItem Content="自动（优先 FFI）" Tag="Auto" />
                                <ComboBoxItem Content="FFI（chaos_ffi.dll）" Tag="Ffi" />
                                <ComboBoxItem Content="Daemon（chaos-daemon.exe）" Tag="Daemon" />
                            </ComboBox>
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="歌词：自动检测" VerticalAlignment="Center" />
                            <ToggleSwitch
                                x:Name="LyricsAutoDetectToggle"
                                Grid.Column="1"
                                OffContent="关闭"
                                OnContent="开启"
                                Toggled="OnLyricsAutoDetectToggled" />
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="弹幕后端" VerticalAlignment="Center" />
                            <ComboBox x:Name="DanmakuBackendCombo" Grid.Column="1" SelectionChanged="OnDanmakuBackendChanged">
                                <ComboBoxItem Content="自动（优先 FFI）" Tag="Auto" />
                                <ComboBoxItem Content="FFI（chaos_ffi.dll）" Tag="Ffi" />
                                <ComboBoxItem Content="Daemon（chaos-daemon.exe）" Tag="Daemon" />
                            </ComboBox>
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="直播：默认全屏播放" VerticalAlignment="Center" />
                            <ToggleSwitch
                                x:Name="LiveDefaultFullscreenToggle"
                                Grid.Column="1"
                                OffContent="关闭"
                                OnContent="开启"
                                Toggled="OnLiveDefaultFullscreenToggled" />
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="直播：全屏动画速率(x)" VerticalAlignment="Center" />
                            <muxc:NumberBox
                                x:Name="LiveFullscreenAnimRateBox"
                                Grid.Column="1"
                                Minimum="0.25"
                                Maximum="2.5"
                                SmallChange="0.1"
                                SpinButtonPlacementMode="Compact"
                                ValueChanged="OnLiveFullscreenAnimRateChanged" />
                        </Grid>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="调试：显示播放提示" VerticalAlignment="Center" />
                            <ToggleSwitch
                                x:Name="DebugPlayerToggle"
                                Grid.Column="1"
                                OffContent="关闭"
                                OnContent="开启"
                                Toggled="OnDebugPlayerToggled" />
                        </Grid>

                        <muxc:InfoBar
                            x:Name="BackdropHint"
                            IsOpen="False"
                            Severity="Informational"
                            Title="提示"
                            Message="Backdrop 仅 Windows 11 生效；Windows 10 将自动降级为“无”。" />
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource ChaosCardBorderStyle}" Padding="16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="歌曲下载" FontSize="18" FontWeight="SemiBold" />
                        <TextBlock Text="提示：网易云默认已内置可用的 API 列表；酷狗已内置直连（无需配置 baseUrl）。" Opacity="0.8" TextWrapping="Wrap" />

                        <Grid RowSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="420" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="网易云 API baseUrls" VerticalAlignment="Center" />
                            <TextBox
                                x:Name="MusicNeteaseBaseUrlsBox"
                                Grid.Row="0"
                                Grid.Column="1"
                                PlaceholderText="多个用 ; 分隔"
                                LostFocus="OnMusicNeteaseBaseUrlsLostFocus" />

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="网易云匿名 cookieUrl" VerticalAlignment="Center" />
                            <TextBox
                                x:Name="MusicNeteaseAnonUrlBox"
                                Grid.Row="1"
                                Grid.Column="1"
                                PlaceholderText="/register/anonimous"
                                LostFocus="OnMusicNeteaseAnonUrlLostFocus" />

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="每次下载都询问保存位置" VerticalAlignment="Center" />
                            <ToggleSwitch
                                x:Name="MusicAskOutDirToggle"
                                Grid.Row="2"
                                Grid.Column="1"
                                OffContent="关闭"
                                OnContent="开启"
                                Toggled="OnMusicAskOutDirToggled" />

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="启用新版音乐界面 (V2)" VerticalAlignment="Center" />
                            <ToggleSwitch
                                x:Name="UseNewMusicUiToggle"
                                Grid.Row="3"
                                Grid.Column="1"
                                OffContent="关闭"
                                OnContent="开启"
                                Toggled="OnUseNewMusicUiToggled" />

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="下载路径模板" VerticalAlignment="Center" />
                            <StackPanel Grid.Row="4" Grid.Column="1" Spacing="4">
                                <TextBox
                                    x:Name="MusicPathTemplateBox"
                                    PlaceholderText="{}{{artist}}/{{album}}/{{title}} - {{artist}}.{{ext}}"
                                    LostFocus="OnMusicPathTemplateLostFocus" />
                                <TextBlock
                                    Text="变量：artist、album、title、ext、track_no（可选）；支持用 / 分隔文件夹。"
                                    Opacity="0.75"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource ChaosCardBorderStyle}" Padding="16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="B站下载" FontSize="18" FontWeight="SemiBold" />
                        <TextBlock Text="提示：Cookie/refresh_token 会明文保存在设置中；不要分享日志/配置文件。" Opacity="0.8" TextWrapping="Wrap" />

                        <Grid RowSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="420" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="后端" VerticalAlignment="Center" />
                            <ComboBox x:Name="BiliBackendCombo" Grid.Row="0" Grid.Column="1" SelectionChanged="OnBiliBackendChanged">
                                <ComboBoxItem Content="自动（优先 FFI）" Tag="Auto" />
                                <ComboBoxItem Content="FFI（chaos_ffi.dll）" Tag="Ffi" />
                                <ComboBoxItem Content="Daemon（chaos-daemon.exe）" Tag="Daemon" />
                            </ComboBox>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="登录状态" VerticalAlignment="Center" />
                            <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Spacing="12">
                                <TextBlock x:Name="BiliLoginStatusText" Text="未登录" Opacity="0.85" VerticalAlignment="Center" />
                                <Button Content="清除登录信息" Click="OnBiliClearLoginClicked" />
                            </StackPanel>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="每次下载都询问保存位置" VerticalAlignment="Center" />
                            <ToggleSwitch
                                x:Name="BiliAskOutDirToggle"
                                Grid.Row="2"
                                Grid.Column="1"
                                OffContent="关闭"
                                OnContent="开启"
                                Toggled="OnBiliAskOutDirToggled" />

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="清晰度优先级" VerticalAlignment="Center" />
                            <TextBox
                                x:Name="BiliDfnPriorityBox"
                                Grid.Row="3"
                                Grid.Column="1"
                                PlaceholderText="逗号分隔，如：1080P 高码率, 1080P 高清, 720P 高清…"
                                TextWrapping="Wrap"
                                LostFocus="OnBiliDfnPriorityLostFocus" />

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="编码优先级" VerticalAlignment="Center" />
                            <TextBox
                                x:Name="BiliEncodingPriorityBox"
                                Grid.Row="4"
                                Grid.Column="1"
                                PlaceholderText="hevc,av1,avc"
                                LostFocus="OnBiliEncodingPriorityLostFocus" />

                            <TextBlock Grid.Row="5" Grid.Column="0" Text="并发 / 重试" VerticalAlignment="Center" />
                            <StackPanel Grid.Row="5" Grid.Column="1" Orientation="Horizontal" Spacing="12">
                                <muxc:NumberBox
                                    x:Name="BiliConcurrencyBox"
                                    Width="150"
                                    Minimum="1"
                                    Maximum="16"
                                    SmallChange="1"
                                    SpinButtonPlacementMode="Compact"
                                    ValueChanged="OnBiliConcurrencyChanged" />
                                <muxc:NumberBox
                                    x:Name="BiliRetriesBox"
                                    Width="150"
                                    Minimum="0"
                                    Maximum="10"
                                    SmallChange="1"
                                    SpinButtonPlacementMode="Compact"
                                    ValueChanged="OnBiliRetriesChanged" />
                            </StackPanel>

                            <TextBlock Grid.Row="6" Grid.Column="0" Text="字幕 / 混流" VerticalAlignment="Center" />
                            <StackPanel Grid.Row="6" Grid.Column="1" Orientation="Horizontal" Spacing="16">
                                <ToggleSwitch x:Name="BiliDownloadSubtitleToggle" OffContent="字幕：关" OnContent="字幕：开" Toggled="OnBiliDownloadSubtitleToggled" />
                                <ToggleSwitch x:Name="BiliSkipMuxToggle" OffContent="混流：开" OnContent="混流：关" Toggled="OnBiliSkipMuxToggled" />
                            </StackPanel>

                            <TextBlock Grid.Row="7" Grid.Column="0" Text="文件名模板" VerticalAlignment="Center" />
                            <StackPanel Grid.Row="7" Grid.Column="1" Spacing="4">
                                <TextBox x:Name="BiliFilePatternBox" PlaceholderText="&lt;videoTitle&gt;" LostFocus="OnBiliFilePatternLostFocus" />
                                <TextBox x:Name="BiliMultiFilePatternBox" PlaceholderText="&lt;videoTitle&gt;/[P&lt;pageNumberWithZero&gt;]&lt;pageTitle&gt;" LostFocus="OnBiliMultiFilePatternLostFocus" />
                            </StackPanel>

                            <TextBlock Grid.Row="8" Grid.Column="0" Text="ffmpeg" VerticalAlignment="Center" />
                            <StackPanel Grid.Row="8" Grid.Column="1" Spacing="6">
                                <TextBlock x:Name="FfmpegPathText" Text="-" Opacity="0.85" TextWrapping="Wrap" />
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <Button x:Name="DownloadFfmpegButton" Content="下载/更新 ffmpeg" Click="OnDownloadFfmpegClicked" />
                                    <Button x:Name="PickFfmpegButton" Content="选择 ffmpeg.exe" Click="OnPickFfmpegClicked" />
                                </StackPanel>
                                <ProgressBar x:Name="FfmpegProgressBar" Minimum="0" Maximum="100" Value="0" Visibility="Collapsed" />
                                <TextBlock x:Name="FfmpegStatusText" Text="" Opacity="0.75" TextWrapping="Wrap" />
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</Page>
