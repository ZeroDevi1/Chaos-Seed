<Page
    x:Class="ChaosSeed.WinUI3.Pages.BiliPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:dl="using:ChaosSeed.WinUI3.Services.Downloads"
    xmlns:local="using:ChaosSeed.WinUI3.Pages"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls">

    <ScrollViewer>
        <Grid Padding="{StaticResource ChaosPagePadding}">
            <Grid.Transitions>
                <TransitionCollection>
                    <EntranceThemeTransition FromVerticalOffset="10" />
                </TransitionCollection>
            </Grid.Transitions>

            <StackPanel Spacing="12">
                <TextBlock Text="B站下载" FontSize="28" FontWeight="SemiBold" />

                <muxc:InfoBar x:Name="InfoBar" IsOpen="False" />

                <!-- Login -->
                <Border Style="{StaticResource ChaosCardBorderStyle}" Padding="16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="登录" FontSize="18" FontWeight="SemiBold" />

                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <TextBlock x:Name="LoginStatusText" Text="未登录" Opacity="0.85" VerticalAlignment="Center" />
                            <TextBlock x:Name="BackendHintText" Text="" Opacity="0.65" VerticalAlignment="Center" TextWrapping="Wrap" />
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <Button Content="扫码登录" Click="OnLoginQrClicked" />
                            <Button Content="刷新 Cookie" Click="OnRefreshCookieClicked" />
                            <Button Content="清除登录" Click="OnClearLoginClicked" />
                        </StackPanel>

                        <StackPanel x:Name="QrPanel" Spacing="10" Visibility="Collapsed">
                            <TextBlock x:Name="QrHintText" Text="" Opacity="0.8" TextWrapping="Wrap" />
                            <Image x:Name="QrImage" Width="220" Height="220" Stretch="Uniform" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Download -->
                <Border Style="{StaticResource ChaosCardBorderStyle}" Padding="16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="下载" FontSize="18" FontWeight="SemiBold" />

                        <TextBox
                            x:Name="InputBox"
                            PlaceholderText="输入 BV/av 或视频链接"
                            TextWrapping="Wrap" />

                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <TextBlock x:Name="OutDirText" Text="输出目录：-" Opacity="0.85" VerticalAlignment="Center" TextWrapping="Wrap" />
                            <Button Content="选择目录" Click="OnPickOutDirClicked" />
                        </StackPanel>

                        <muxc:Expander Header="高级选项" IsExpanded="False">
                            <StackPanel Spacing="10" Margin="0,10,0,0">
                                <TextBox x:Name="SelectPageBox" PlaceholderText="selectPage: ALL / 1,2 / 3-5 / LAST / LATEST" />
                                <TextBox x:Name="DfnPriorityBox" PlaceholderText="清晰度优先级（逗号分隔，如：1080P 高码率, 1080P 高清, ...）" TextWrapping="Wrap" />
                                <TextBox x:Name="EncodingPriorityBox" PlaceholderText="编码优先级（逗号分隔，如：hevc,av1,avc）" />

                                <Grid ColumnSpacing="12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <muxc:NumberBox
                                        x:Name="ConcurrencyBox"
                                        Grid.Column="0"
                                        Header="并发"
                                        Minimum="1"
                                        Maximum="16"
                                        SmallChange="1"
                                        SpinButtonPlacementMode="Compact" />

                                    <muxc:NumberBox
                                        x:Name="RetriesBox"
                                        Grid.Column="1"
                                        Header="重试"
                                        Minimum="0"
                                        Maximum="10"
                                        SmallChange="1"
                                        SpinButtonPlacementMode="Compact" />
                                </Grid>

                                <StackPanel Orientation="Horizontal" Spacing="16">
                                    <CheckBox x:Name="DownloadSubtitleToggle" Content="下载字幕并转 srt" />
                                    <CheckBox x:Name="SkipMuxToggle" Content="跳过混流（仅下载流）" />
                                </StackPanel>

                                <TextBox x:Name="FilePatternBox" PlaceholderText="filePattern（如：&lt;videoTitle&gt;）" />
                                <TextBox x:Name="MultiFilePatternBox" PlaceholderText="multiFilePattern（如：&lt;videoTitle&gt;/[P&lt;pageNumberWithZero&gt;]&lt;pageTitle&gt;）" />

                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <TextBlock x:Name="FfmpegPathText" Text="ffmpeg：-" Opacity="0.85" VerticalAlignment="Center" TextWrapping="Wrap" />
                                    <Button Content="选择 ffmpeg.exe" Click="OnPickFfmpegClicked" />
                                </StackPanel>
                            </StackPanel>
                        </muxc:Expander>

                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <Button Content="解析" Click="OnParseClicked" />
                            <Button Content="开始下载" Click="OnStartDownloadClicked" />
                        </StackPanel>

                        <muxc:Expander x:Name="ParsedExpander" Header="解析结果" IsExpanded="False" Visibility="Collapsed">
                            <StackPanel Spacing="10" Margin="0,10,0,0">
                                <TextBlock x:Name="ParsedTitleText" Text="" FontWeight="SemiBold" TextWrapping="Wrap" />
                                <ListView
                                    x:Name="ParsedPagesList"
                                    ItemsSource="{x:Bind ParsedPages, Mode=OneWay}"
                                    SelectionMode="None">
                                    <ListView.ItemTemplate>
                                        <DataTemplate x:DataType="local:BiliParsedPageVm">
                                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="10" Padding="10" Margin="0,0,0,8">
                                                <StackPanel Orientation="Horizontal" Spacing="10">
                                                    <CheckBox IsChecked="{x:Bind IsSelected, Mode=TwoWay}" />
                                                    <StackPanel Spacing="2">
                                                        <TextBlock Text="{x:Bind Title}" FontWeight="SemiBold" TextWrapping="Wrap" />
                                                        <TextBlock Text="{x:Bind Sub}" Opacity="0.7" TextWrapping="Wrap" />
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </StackPanel>
                        </muxc:Expander>
                    </StackPanel>
                </Border>

                <!-- Active downloads -->
                <Border Style="{StaticResource ChaosCardBorderStyle}" Padding="16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="任务进度" FontSize="18" FontWeight="SemiBold" />

                        <ListView
                            x:Name="SessionsList"
                            ItemsSource="{x:Bind Sessions, Mode=OneWay}"
                            SelectionMode="None">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="dl:BiliDownloadSessionVm">
                                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="10" Padding="12" Margin="0,0,0,10">
                                        <StackPanel Spacing="10">
                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <TextBlock Text="{x:Bind Title}" FontWeight="SemiBold" TextWrapping="Wrap" />
                                                <TextBlock Text="{x:Bind TotalsText}" Opacity="0.7" VerticalAlignment="Center" TextWrapping="Wrap" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <Button Content="取消" Tag="{x:Bind}" Click="OnCancelSessionClicked" />
                                                <Button Content="移除" Tag="{x:Bind}" Click="OnRemoveSessionClicked" />
                                                <TextBlock Text="{x:Bind StartedAtText}" Opacity="0.65" VerticalAlignment="Center" />
                                            </StackPanel>

                                            <ListView ItemsSource="{x:Bind Jobs, Mode=OneWay}" SelectionMode="None">
                                                <ListView.ItemTemplate>
                                                    <DataTemplate x:DataType="dl:BiliDownloadJobVm">
                                                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="10" Padding="10" Margin="0,0,0,8">
                                                            <StackPanel Spacing="6">
                                                                <StackPanel Orientation="Horizontal" Spacing="10">
                                                                    <TextBlock Text="{x:Bind IndexText}" Opacity="0.75" />
                                                                    <TextBlock Text="{x:Bind State}" Opacity="0.75" />
                                                                    <TextBlock Text="{x:Bind Phase}" Opacity="0.65" />
                                                                </StackPanel>
                                                                <TextBlock Text="{x:Bind Title}" FontWeight="SemiBold" TextWrapping="Wrap" />
                                                                <ProgressBar Minimum="0" Maximum="1" Value="{x:Bind ProgressValue, Mode=OneWay}" />
                                                                <TextBlock Text="{x:Bind ProgressText}" Opacity="0.75" TextWrapping="Wrap" />
                                                                <TextBlock Text="{x:Bind Error}" Opacity="0.7" TextWrapping="Wrap" />
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ListView.ItemTemplate>
                                            </ListView>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</Page>
