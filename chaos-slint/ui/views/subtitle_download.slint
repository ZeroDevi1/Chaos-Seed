import { SubtitleRow } from "../models.slint";
import { AppTheme } from "../theme.slint";
import {
    AppButton,
    AppLineEdit,
    FieldLabel,
    ButtonKind,
} from "../components/widgets.slint";
import { ScrollView } from "std-widgets.slint";

export component SubtitleDownloadView inherits VerticalLayout {
    in-out property <string> query: "";
    in-out property <string> min_score: "";
    in-out property <string> lang: "";
    in-out property <string> limit: "20";

    in-out property <bool> busy: false;
    in-out property <string> status_text: "";

    in property <[SubtitleRow]> results: [];

    callback search_clicked(string, string, string, string);
    callback download_one(int);

    spacing: 12px;
    padding: 24px;
    alignment: start;
    horizontal-stretch: 1;
    vertical-stretch: 1;
    min-height: 0;

    Text {
        text: "字幕下载";
        font-size: 22px;
        font-weight: 700;
        color: AppTheme.text_primary;
    }

    Text {
        text: "使用说明：输入关键词（回车或点击搜索）-> 列表展示 -> 点击某条“下载” -> 选择保存目录 -> 开始下载。";
        color: AppTheme.text_secondary;
        wrap: word-wrap;
    }

    // Query + actions
    VerticalLayout {
        spacing: 6px;
        alignment: start;
        FieldLabel {
            label: "关键词";
        }

        HorizontalLayout {
            spacing: 12px;
            alignment: start;

            Rectangle {
                width: 520px;
                height: 36px;
                background: transparent;
                AppLineEdit {
                    width: parent.width;
                    placeholder-text: "";
                    text <=> root.query;
                    enabled: !root.busy;
                    accepted(t) => {
                        root.search_clicked(t, root.min_score, root.lang, root.limit);
                    }
                }
            }

            AppButton {
                width: 120px;
                text: root.busy ? "处理中..." : "搜索";
                enabled: !root.busy;
                clicked => {
                    root.search_clicked(root.query, root.min_score, root.lang, root.limit);
                }
            }
        }
    }

    // Filters row
    HorizontalLayout {
        spacing: 12px;
        alignment: start;

        VerticalLayout {
            spacing: 6px;
            alignment: start;
            FieldLabel {
                label: "最低分数(min_score，可空)";
            }

            Rectangle {
                width: 180px;
                height: 36px;
                background: transparent;
                AppLineEdit {
                    placeholder-text: "例如：50";
                    text <=> root.min_score;
                    enabled: !root.busy;
                }
            }
        }

        VerticalLayout {
            spacing: 6px;
            alignment: start;
            FieldLabel {
                label: "语言(lang，可空)";
            }

            Rectangle {
                width: 160px;
                height: 36px;
                background: transparent;
                AppLineEdit {
                    placeholder-text: "例如：zh / en";
                    text <=> root.lang;
                    enabled: !root.busy;
                }
            }
        }

        VerticalLayout {
            spacing: 6px;
            alignment: start;
            FieldLabel {
                label: "数量(limit)";
            }

            Rectangle {
                width: 120px;
                height: 36px;
                background: transparent;
                AppLineEdit {
                    placeholder-text: "默认 20";
                    text <=> root.limit;
                    enabled: !root.busy;
                }
            }
        }
    }

    Text {
        text: "提示：搜索后每条结果右侧都有“下载”按钮；点击后会弹出目录选择（每次下载都需要选择目录）。";
        color: AppTheme.text_muted;
        wrap: word-wrap;
    }

    Text {
        text: root.status_text;
        color: AppTheme.text_secondary;
        wrap: word-wrap;
    }

    Rectangle {
        height: 1px;
        background: AppTheme.border_color;
    }

    // Results list
    Rectangle {
        border-width: 1px;
        border-color: AppTheme.border_color;
        border-radius: 6px;
        background: AppTheme.card_bg;
        horizontal-stretch: 1;
        // Let the results panel take the remaining vertical space, but keep
        // a minimum height so it never collapses to ~0px.
        vertical-stretch: 1;
        min-height: 260px;

        clip: true;

        // Use a fixed-size ScrollView (no Layout-managed height) to avoid backend-specific
        // sizing issues that can collapse the list to 1 row or hide content.
        inner := Rectangle {
            x: 8px;
            y: 8px;
            width: parent.width - 16px;
            height: parent.height - 16px;
            background: transparent;
            clip: true;

            if (root.results.length == 0): Text {
                x: 0;
                y: 0;
                width: parent.width;
                text: root.busy ? "正在搜索..." : "暂无结果：请先搜索关键词。";
                color: AppTheme.text_muted;
                wrap: word-wrap;
            }

            results_scroll := ScrollView {
                visible: root.results.length > 0;
                enabled: true;
                x: 0;
                y: 0;
                width: parent.width;
                height: parent.height;

                property <length> row_h: 52px;
                property <length> row_gap: 6px;
                property <length> row_step: row_h + row_gap;
                property <length> content_h: root.results.length > 0
                    ? (root.results.length * row_step - row_gap)
                    : 0px;

                viewport-width: self.visible-width;
                viewport-height: max(self.visible-height, content_h);

                content := Rectangle {
                    width: parent.width;
                    height: results_scroll.content_h;
                    background: transparent;

                    for row[i] in root.results: Rectangle {
                        x: 0;
                        y: i * results_scroll.row_step;
                        width: parent.width;
                        height: results_scroll.row_h;
                        border-radius: 6px;
                        border-width: 1px;
                        border-color: AppTheme.border_color;
                        background: area.has-hover ? AppTheme.hover_bg : transparent;
                        area := TouchArea {
                            width: parent.width;
                            height: parent.height;
                        }

                        HorizontalLayout {
                            width: parent.width;
                            height: parent.height;
                            padding-left: 10px;
                            padding-right: 10px;
                            spacing: 10px;
                            alignment: start;

                            Text {
                                text: row.score;
                                width: 64px;
                                color: AppTheme.text_primary;
                                horizontal-alignment: left;
                            }

                            Text {
                                text: row.name;
                                horizontal-stretch: 1;
                                color: AppTheme.text_primary;
                                overflow: elide;
                                horizontal-alignment: left;
                            }

                            Text {
                                text: row.ext;
                                width: 50px;
                                color: AppTheme.text_secondary;
                            }

                            Text {
                                text: row.languages;
                                width: 120px;
                                color: AppTheme.text_secondary;
                                overflow: elide;
                            }

                            Text {
                                text: row.extra_name;
                                width: 160px;
                                color: AppTheme.text_secondary;
                                overflow: elide;
                                horizontal-alignment: right;
                            }

                            // Right-align the download button within a fixed-width cell so the
                            // last two columns ("来源" + "下载") look balanced.
                            Rectangle {
                                width: 120px;
                                height: parent.height;
                                background: transparent;
                                AppButton {
                                    x: parent.width - self.width;
                                    y: (parent.height - self.height) / 2;
                                    kind: ButtonKind.Secondary;
                                    text: "下载";
                                    enabled: !root.busy;
                                    clicked => {
                                        root.download_one(i);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
