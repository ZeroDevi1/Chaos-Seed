import { Sidebar } from "components/sidebar.slint";
import { ThemeToggle } from "components/theme_toggle.slint";
import { HomeView } from "views/home.slint";
import { SubtitleDownloadView } from "views/subtitle_download.slint";
import { LiveSourceView } from "views/live_source.slint";
import { DanmakuView } from "views/danmaku.slint";
import { SettingsView } from "views/settings.slint";
import { AboutView } from "views/about.slint";
import { DanmakuOverlayWindow } from "windows/danmaku_overlay_window.slint";
import { DanmakuChatWindow } from "windows/danmaku_chat_window.slint";
import { SubtitleRow, DanmakuRow } from "models.slint";
import { AppTheme } from "theme.slint";
import { Palette } from "std-widgets.slint";

export { AppTheme }
export { Palette }
export { DanmakuOverlayWindow, DanmakuChatWindow }

export component AppWindow inherits Window {
    title: "Chaos Seed";
    min-width: 1000px;
    min-height: 700px;
    background: AppTheme.app_bg;

    in-out property <int> page_index: 0;
    in-out property <bool> busy: false;
    in-out property <string> status_text: "";

    in-out property <bool> dark_mode: false;

    in-out property <string> version: "";
    in-out property <string> homepage: "";

    // Subtitle search input
    in-out property <string> query: "";
    in-out property <string> min_score: "";
    in-out property <string> lang: "";
    in-out property <string> limit: "20";

    // Results model
    in property <[SubtitleRow]> results: [];

    // Callbacks implemented in Rust
    callback search_clicked(string, string, string, string);
    callback download_one(int);
    callback open_url(string);
    callback dark_mode_changed(bool);

    // Danmaku test page
    in-out property <string> danmaku_input: "";
    in-out property <string> danmaku_status: "";
    in-out property <bool> danmaku_connected: false;
    in property <[DanmakuRow]> danmaku_messages: [];

    callback danmaku_connect(string);
    callback danmaku_disconnect();
    callback danmaku_open_chat_window();
    callback danmaku_open_overlay_window();

    HorizontalLayout {
        Sidebar {
            selected_index: root.page_index;
            enabled: !root.busy;
            tab_selected(i) => { root.page_index = i; }
        }

        Rectangle {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            background: transparent;

            VerticalLayout {
                padding: 0px;
                spacing: 0px;
                alignment: start;

                // Top bar (theme toggle)
                Rectangle {
                    height: 48px;
                    background: transparent;
                    HorizontalLayout {
                        padding-left: 12px;
                        padding-right: 12px;
                        alignment: start;
                        Rectangle { horizontal-stretch: 1; }
                        ThemeToggle {
                            dark_mode <=> root.dark_mode;
                            enabled: !root.busy;
                            toggled(v) => { root.dark_mode_changed(v); }
                        }
                    }
                }

                Rectangle {
                    horizontal-stretch: 1;
                    vertical-stretch: 1;
                    background: transparent;

                    if (root.page_index == 0): HomeView {
                        width: parent.width;
                        height: parent.height;
                        go_subtitle => { root.page_index = 1; }
                    }

                    if (root.page_index == 1): SubtitleDownloadView {
                        width: parent.width;
                        height: parent.height;
                        query <=> root.query;
                        min_score <=> root.min_score;
                        lang <=> root.lang;
                        limit <=> root.limit;
                        busy <=> root.busy;
                        status_text <=> root.status_text;
                        results: root.results;

                        search_clicked(q, ms, l, lim) => { root.search_clicked(q, ms, l, lim); }
                        download_one(i) => { root.download_one(i); }
                    }

                    if (root.page_index == 2): LiveSourceView {
                        width: parent.width;
                        height: parent.height;
                    }

                    if (root.page_index == 3): DanmakuView {
                        width: parent.width;
                        height: parent.height;
                        input <=> root.danmaku_input;
                        status <=> root.danmaku_status;
                        connected <=> root.danmaku_connected;
                        messages: root.danmaku_messages;

                        connect(input) => { root.danmaku_connect(input); }
                        disconnect() => { root.danmaku_disconnect(); }
                        open_chat_window() => { root.danmaku_open_chat_window(); }
                        open_overlay_window() => { root.danmaku_open_overlay_window(); }
                        open_url(url) => { root.open_url(url); }
                    }

                    if (root.page_index == 4): SettingsView {
                        width: parent.width;
                        height: parent.height;
                    }

                    if (root.page_index == 5): AboutView {
                        width: parent.width;
                        height: parent.height;
                        version: root.version;
                        homepage: root.homepage;
                        open_url(url) => { root.open_url(url); }
                    }
                }
            }
        }
    }
}
