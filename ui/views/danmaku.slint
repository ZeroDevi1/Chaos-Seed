import { AppTheme } from "../theme.slint";
import { DanmakuRow } from "../models.slint";
import {
    AppButton,
    AppLineEdit,
    FieldLabel,
    ButtonKind,
} from "../components/widgets.slint";

export component DanmakuView inherits VerticalLayout {
    in-out property <string> input: "";
    in-out property <string> status: "";
    in-out property <bool> connected: false;
    in property <[DanmakuRow]> messages: [];

    callback connect(string);
    callback disconnect();
    callback open_chat_window();
    callback open_overlay_window();
    callback open_url(string);

    spacing: 12px;
    padding: 24px;
    alignment: start;
    horizontal-stretch: 1;
    vertical-stretch: 1;
    min-height: 0;

    Text {
        text: "弹幕";
        font-size: 22px;
        font-weight: 700;
        color: AppTheme.text_primary;
    }

    Text {
        text: "输入直播间 URL（B 站/斗鱼/虎牙）后点击“解析/连接”，页面下方会以 Chat 方式实时输出弹幕。";
        color: AppTheme.text_secondary;
        wrap: word-wrap;
    }

    // Input + actions
    VerticalLayout {
        spacing: 6px;
        alignment: start;

        FieldLabel { label: "直播间地址"; }

        // Row 1: URL + connect/disconnect (responsive, won't cover buttons on narrow widths)
        HorizontalLayout {
            spacing: 12px;
            alignment: start;

            Rectangle {
                horizontal-stretch: 1;
                min-width: 260px;
                height: 36px;
                background: transparent;

                AppLineEdit {
                    width: parent.width;
                    placeholder-text: "例如：https://live.bilibili.com/1 / https://www.douyu.com/xxx / https://www.huya.com/xxx";
                    text <=> root.input;
                    accepted(t) => { root.connect(t); }
                }
            }

            AppButton {
                width: 120px;
                text: root.connected ? "已连接" : "解析/连接";
                enabled: !root.connected;
                clicked => { root.connect(root.input); }
            }

            AppButton {
                width: 92px;
                kind: ButtonKind.Secondary;
                text: "断开";
                enabled: root.connected;
                clicked => { root.disconnect(); }
            }
        }

        // Row 2: open floating windows
        HorizontalLayout {
            spacing: 12px;
            alignment: start;

            AppButton {
                kind: ButtonKind.Secondary;
                text: "Chat 窗口";
                enabled: root.connected;
                clicked => { root.open_chat_window(); }
            }

            AppButton {
                kind: ButtonKind.Secondary;
                text: "Overlay 窗口";
                enabled: root.connected;
                clicked => { root.open_overlay_window(); }
            }
        }
    }

    Rectangle { height: 1px; background: AppTheme.border_color; }

    Text {
        text: root.status;
        color: AppTheme.text_secondary;
        wrap: word-wrap;
    }

    // Messages panel (bottom-up chat)
    Rectangle {
        border-width: 1px;
        border-color: AppTheme.border_color;
        border-radius: 6px;
        background: AppTheme.card_bg;
        horizontal-stretch: 1;
        vertical-stretch: 1;
        min-height: 260px;
        clip: true;

        property <length> pad: 12px;
        property <length> row_min_h: 26px;
        property <length> row_gap: 6px;

        inner := Rectangle {
            x: pad;
            y: pad;
            width: max(0px, parent.width - (pad * 2));
            height: max(0px, parent.height - (pad * 2));
            background: transparent;
            clip: true;

            if (root.messages.length == 0): Text {
                x: 0;
                y: 0;
                width: parent.width;
                text: root.connected ? "已连接：等待弹幕..." : "请先输入直播间地址并点击“解析/连接”。";
                color: AppTheme.text_muted;
                wrap: word-wrap;
            }

            // Use a layout-driven list so rows can auto-grow when the message wraps.
            // Anchor the whole list to the bottom so it behaves like a chat (newest at the bottom).
            messages_list := VerticalLayout {
                visible: root.messages.length > 0;
                x: 0;
                width: parent.width;
                spacing: row_gap;
                alignment: start;
                height: self.preferred-height;
                y: parent.height - self.height;

                for msg[i] in root.messages: Rectangle {
                    width: parent.width;
                    background: transparent;
                    height: max(row_min_h, msg_text.preferred-height);

                    HorizontalLayout {
                        width: parent.width;
                        height: parent.height;
                        spacing: 8px;
                        alignment: start;

                        msg_text := Text {
                            text: msg.user + "：" + ((msg.text == "[图片]" || msg.text == "[表情]") ? "" : msg.text);
                            horizontal-stretch: 1;
                            color: AppTheme.text_primary;
                            font-size: 13px;
                            wrap: word-wrap;
                            vertical-alignment: top;
                        }

                        Rectangle {
                            visible: msg.image_url != "";
                            width: msg.image_w;
                            height: row_min_h;
                            background: transparent;

                            Image {
                                width: parent.width;
                                height: parent.height;
                                source: msg.image;
                                image-fit: contain;
                            }

                            // Placeholder text while the thumbnail is still loading.
                            Text {
                                width: parent.width;
                                height: parent.height;
                                text: "IMG";
                                color: AppTheme.text_muted;
                                font-size: 10px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                visible: !msg.image_ready;
                            }

                            TouchArea {
                                width: parent.width;
                                height: parent.height;
                                mouse-cursor: pointer;
                                clicked => { root.open_url(msg.image_url); }
                            }
                        }
                    }
                }
            }
        }
    }
}
