import { AppTheme } from "../theme.slint";
import { AppButton, FieldLabel, ButtonKind } from "../components/widgets.slint";
import { ComboBox } from "std-widgets.slint";
// Ensure the window components are compiled and exported for Rust.
import { DanmakuChatWindow } from "../windows/danmaku_chat_window.slint";
import { DanmakuOverlayWindow } from "../windows/danmaku_overlay_window.slint";

export component DanmakuView inherits VerticalLayout {
    in-out property <int> style_index: 0;
    in-out property <bool> running: false;

    callback danmaku_start(style_index: int, always_on_top: bool);
    callback danmaku_stop();

    spacing: 12px;
    padding: 24px;
    alignment: start;
    horizontal-stretch: 1;
    vertical-stretch: 1;
    min-height: 0;

    Text {
        text: "弹幕";
        font-size: 22px;
        font-weight: 700;
        color: AppTheme.text_primary;
    }

    Text {
        text: "占位：后续将支持解析不同平台直播间 URL（如 B 站/斗鱼/虎牙），连接弹幕流并展示。";
        color: AppTheme.text_secondary;
        wrap: word-wrap;
    }

    Rectangle {
        border-width: 1px;
        border-color: AppTheme.border_color;
        border-radius: 8px;
        background: AppTheme.card_bg;
        horizontal-stretch: 1;

        VerticalLayout {
            padding: 14px;
            spacing: 8px;
            alignment: start;

            Text {
                text: "计划两种展示形态（本次不实现）：";
                color: AppTheme.text_primary;
                font-weight: 600;
            }

            Text {
                text: "1) 竖直 Chat：类似 YouTube Chat，背景不透明，弹幕从下向上滚动，可置顶。";
                color: AppTheme.text_secondary;
                wrap: word-wrap;
            }

            Text {
                text: "2) 水平 Overlay：类似 B 站滚动弹幕，背景透明，从右向左滚动，支持置顶（可在 A 直播间叠 B 弹幕）。";
                color: AppTheme.text_secondary;
                wrap: word-wrap;
            }
        }
    }

    Rectangle { height: 1px; background: AppTheme.border_color; }

    // Simulated danmaku launcher
    VerticalLayout {
        spacing: 10px;
        alignment: start;

        Text {
            text: "模拟弹幕（开发用）";
            color: AppTheme.text_primary;
            font-weight: 600;
        }

        HorizontalLayout {
            spacing: 12px;
            alignment: start;

            VerticalLayout {
                spacing: 6px;
                alignment: start;
                FieldLabel { label: "样式"; }
                ComboBox {
                    enabled: !root.running;
                    model: ["竖直 Chat", "水平 Overlay"];
                    current-index <=> root.style_index;
                }
            }

            Rectangle { horizontal-stretch: 1; }

            AppButton {
                text: root.running ? "关闭" : "启动";
                kind: root.running ? ButtonKind.Secondary : ButtonKind.Primary;
                clicked => {
                    if (root.running) {
                        root.danmaku_stop();
                    } else {
                        // Overlay 默认置顶；Chat 的置顶开关放在窗口内。
                        root.danmaku_start(root.style_index, root.style_index == 1);
                    }
                }
            }
        }

        Text {
            text: root.running
                ? "运行中：关闭后将停止随机弹幕生成。"
                : "提示：启动后会以“人性化”随机间隔生成弹幕，偶尔进入高能爆发期。";
            color: AppTheme.text_muted;
            wrap: word-wrap;
        }
    }
}
