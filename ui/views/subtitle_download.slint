import { SubtitleRow } from "../models.slint";
import { AppTheme } from "../theme.slint";
import {
    AppButton,
    AppLineEdit,
    FieldLabel,
    ButtonKind,
} from "../components/widgets.slint";
import { ScrollView,ListView } from "std-widgets.slint";

export component SubtitleDownloadView inherits VerticalLayout {
    in-out property <string> query: "";
    in-out property <string> min_score: "";
    in-out property <string> lang: "";
    in-out property <string> limit: "20";

    in-out property <bool> busy: false;
    in-out property <string> status_text: "";

    in property <[SubtitleRow]> results: [];

    callback search_clicked(string, string, string, string);
    callback download_one(int);

    spacing: 12px;
    padding: 24px;
    alignment: start;
    horizontal-stretch: 1;
    vertical-stretch: 1;
    min-height: 0;

    Text {
        text: "字幕下载";
        font-size: 22px;
        font-weight: 700;
        color: AppTheme.text_primary;
    }

    Text {
        text: "使用说明：输入关键词（回车或点击搜索）-> 列表展示 -> 点击某条“下载” -> 选择保存目录 -> 开始下载。";
        color: AppTheme.text_secondary;
        wrap: word-wrap;
    }

    // Query + actions
    VerticalLayout {
        spacing: 6px;
        alignment: start;
        FieldLabel {
            label: "关键词";
        }

        HorizontalLayout {
            spacing: 12px;
            alignment: start;

            Rectangle {
                width: 520px;
                height: 36px;
                background: transparent;
                AppLineEdit {
                    width: parent.width;
                    placeholder-text: "例如：泽塔奥特曼 / 电影名 / 剧名（回车搜索）";
                    text <=> root.query;
                    enabled: !root.busy;
                    accepted(t) => {
                        root.search_clicked(t, root.min_score, root.lang, root.limit);
                    }
                }
            }

            AppButton {
                width: 120px;
                text: root.busy ? "处理中..." : "搜索";
                enabled: !root.busy;
                clicked => {
                    root.search_clicked(root.query, root.min_score, root.lang, root.limit);
                }
            }
        }
    }

    // Filters row
    HorizontalLayout {
        spacing: 12px;
        alignment: start;

        VerticalLayout {
            spacing: 6px;
            alignment: start;
            FieldLabel {
                label: "最低分数(min_score，可空)";
            }

            Rectangle {
                width: 180px;
                height: 36px;
                background: transparent;
                AppLineEdit {
                    placeholder-text: "例如：50";
                    text <=> root.min_score;
                    enabled: !root.busy;
                }
            }
        }

        VerticalLayout {
            spacing: 6px;
            alignment: start;
            FieldLabel {
                label: "语言(lang，可空)";
            }

            Rectangle {
                width: 160px;
                height: 36px;
                background: transparent;
                AppLineEdit {
                    placeholder-text: "例如：zh / en";
                    text <=> root.lang;
                    enabled: !root.busy;
                }
            }
        }

        VerticalLayout {
            spacing: 6px;
            alignment: start;
            FieldLabel {
                label: "数量(limit)";
            }

            Rectangle {
                width: 120px;
                height: 36px;
                background: transparent;
                AppLineEdit {
                    placeholder-text: "默认 20";
                    text <=> root.limit;
                    enabled: !root.busy;
                }
            }
        }
    }

    Text {
        text: "提示：搜索后每条结果右侧都有“下载”按钮；点击后会弹出目录选择（每次下载都需要选择目录）。";
        color: AppTheme.text_muted;
        wrap: word-wrap;
    }

    Text {
        text: root.status_text;
        color: AppTheme.text_secondary;
        wrap: word-wrap;
    }

    Rectangle {
        height: 1px;
        background: AppTheme.border_color;
    }

    // Results list
    Rectangle {
        border-width: 1px;
        border-color: AppTheme.border_color;
        border-radius: 6px;
        background: AppTheme.card_bg;
        horizontal-stretch: 1;
        vertical-stretch: 1;
        min-height: 0;

        // Use ScrollView to get a robust viewport + clipping + optional scrolling behavior
        // across render backends.
        VerticalLayout {
            x: 8px;
            y: 8px;
            width: parent.width - 16px;
            height: parent.height - 16px;
            spacing: 8px;
            alignment: start;

            if (root.results.length == 0): Text {
                text: root.busy ? "正在搜索..." : "暂无结果：请先搜索关键词。";
                color: AppTheme.text_muted;
                wrap: word-wrap;
            }

            if (root.results.length > 0): ScrollView {
                enabled: true;
                horizontal-stretch: 1;
                vertical-stretch: 1;
                // height: parent.height;
                VerticalLayout {
                    horizontal-stretch: 1;
                    spacing: 6px;
                    alignment: start;

                    for row[i] in root.results: Rectangle {
                        horizontal-stretch: 1;
                        height: 52px;
                        border-radius: 6px;
                        border-width: 1px;
                        border-color: AppTheme.border_color;
                        background: area.has-hover ? AppTheme.hover_bg : transparent;
                        area := TouchArea {
                            width: parent.width;
                            height: parent.height;
                        }

                        HorizontalLayout {
                            width: parent.width;
                            height: parent.height;
                            padding-left: 10px;
                            padding-right: 10px;
                            spacing: 10px;
                            alignment: start;

                            Text {
                                text: row.score;
                                width: 64px;
                                color: AppTheme.text_primary;
                            }

                            Text {
                                text: row.name;
                                horizontal-stretch: 1;
                                color: AppTheme.text_primary;
                                overflow: elide;
                            }

                            Text {
                                text: row.ext;
                                width: 50px;
                                color: AppTheme.text_secondary;
                            }

                            Text {
                                text: row.languages;
                                width: 120px;
                                color: AppTheme.text_secondary;
                                overflow: elide;
                            }

                            Text {
                                text: row.extra_name;
                                width: 160px;
                                color: AppTheme.text_secondary;
                                overflow: elide;
                            }

                            AppButton {
                                kind: ButtonKind.Secondary;
                                text: "下载";
                                enabled: !root.busy;
                                clicked => {
                                    root.download_one(i);
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
